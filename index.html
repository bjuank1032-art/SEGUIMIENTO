<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sistema 3 de Junio - Espejo de Realidad</title>
    
    <!-- Scripts de Dependencias -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            background-color: black;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 120px;
        }

        .admin-panel {
            background: #1c1c1e;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 9999;
        }

        .glass-modal {
            background: rgba(10, 10, 10, 0.98) !important;
            backdrop-filter: blur(50px) !important;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .input-dark {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            color: white;
            border-radius: 1.5rem;
            padding: 1.2rem;
        }

        .roadmap-line-gradient { 
            background: linear-gradient(to bottom, #ef4444, #3b82f6, #10b981, #f59e0b, #a855f7); 
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 20px rgba(220, 38, 38, 0.1); }
            50% { box-shadow: 0 0 40px rgba(220, 38, 38, 0.3); }
        }
        .failure-alert { animation: pulse-red 2s infinite; border-color: rgba(220, 38, 38, 0.5) !important; }

        .btn-commitment {
            background: white;
            color: black;
            font-weight: 900;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-commitment:hover { transform: scale(1.02); box-shadow: 0 0 30px rgba(255,255,255,0.2); }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const KEY_H = 'res_v13_habits';
        const KEY_W = 'last_win_date';
        const KEY_API = 'gemini_stored_key';
        const KEY_R = 'res_v13_roadmap';
        const COLORS = ['#007aff', '#34c759', '#ff3b30', '#ff9500', '#af52de', '#ff2d55', '#00c7be'];
        const DAYS_WEEK = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
        
        const ALL_OBJECTIVES = [
            { id: "1", text: "Dejar de fumar marihuana" }, { id: "2", text: "UdeA (Acad√©mico)" }, { id: "3", text: "Masa Muscular" },
            { id: "4", text: "Meditar" }, { id: "5", text: "Control Mental" }, { id: "6", text: "6:30 AM" },
            { id: "7", text: "10:30 PM" }, { id: "8", text: "Ingl√©s y Excel" }, { id: "9", text: "Empleo" },
            { id: "10", text: "SPLENDOR" }, { id: "11", text: "Dinero" }, { id: "12", text: "Recuperar Cabello" }
        ];

        const Icon = ({ name, className = "w-5 h-5", color = "currentColor" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    iconRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    const lucideName = name.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
                    i.setAttribute('data-lucide', lucideName);
                    i.className = className;
                    i.style.stroke = color;
                    i.style.strokeWidth = "2.5";
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons();
                }
            }, [name, className, color]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        const App = () => {
            const [timeOffset, setTimeOffset] = useState(0); 
            const simulatedNow = useMemo(() => new Date(Date.now() + timeOffset * 86400000), [timeOffset]);
            const simulatedHoyStr = simulatedNow.toISOString().split('T')[0];

            const [activeTab, setActiveTab] = useState('seguimiento');
            const [habits, setHabits] = useState(() => JSON.parse(localStorage.getItem(KEY_H)) || []);
            const [lastWinDate, setLastWinDate] = useState(() => localStorage.getItem(KEY_W) || null);
            const [roadmap, setRoadmap] = useState(() => JSON.parse(localStorage.getItem(KEY_R)) || []);
            
            const [showAddModal, setShowAddModal] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showJuez, setShowJuez] = useState(false);
            const [expandedStep, setExpandedStep] = useState(1);
            const [editingHabit, setEditingHabit] = useState(null);
            const [storedApiKey, setStoredApiKey] = useState(localStorage.getItem(KEY_API) || "");
            const [reflection, setReflection] = useState("");
            const [aiFeedback, setAiFeedback] = useState("");
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [verdictValid, setVerdictValid] = useState(false);

            const [formData, setFormData] = useState({ 
                name: "", icon: "üî•", color: COLORS[0], duration: 30, type: 'simple', 
                routine: DAYS_WEEK.reduce((acc, day) => ({...acc, [day]: ""}), {}) 
            });

            useEffect(() => {
                localStorage.setItem(KEY_H, JSON.stringify(habits));
                if (lastWinDate) localStorage.setItem(KEY_W, lastWinDate);
            }, [habits, lastWinDate]);

            const failurePorc = useMemo(() => {
                if (!lastWinDate) return 0;
                const last = new Date(lastWinDate); last.setHours(0,0,0,0);
                const today = new Date(simulatedNow); today.setHours(0,0,0,0);
                const diffDays = Math.floor((today - last) / (1000 * 60 * 60 * 24));
                return Math.min(100, diffDays * 20); 
            }, [lastWinDate, simulatedNow]);

            useEffect(() => {
                if (failurePorc >= 100) setShowJuez(true);
            }, [failurePorc]);

            const calculateStats = (h) => {
                const start = new Date(h.startDate); start.setHours(0,0,0,0);
                const today = new Date(simulatedNow); today.setHours(0,0,0,0);
                const totalElapsed = Math.floor((today - start) / (1000 * 60 * 60 * 24)) + 1;
                let activeDays = 0;
                const daysMap = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
                for(let i=0; i<totalElapsed; i++) {
                    const check = new Date(start); check.setDate(start.getDate() + i);
                    const dayName = daysMap[check.getDay()];
                    const task = h.type === 'routine' ? h.routine[dayName] : "Activo";
                    if (task && task.trim() !== "" && !task.toLowerCase().includes("descanso")) activeDays++;
                }
                const completed = h.history.length;
                const failed = Math.max(0, activeDays - completed);
                const progress = activeDays > 0 ? Math.min(100, Math.round((completed / activeDays) * 100)) : 100;
                return { completed, failed, progress };
            };

            // Estad√≠sticas globales para el Juez
            const globalStats = useMemo(() => {
                return habits.reduce((acc, h) => {
                    const s = calculateStats(h);
                    acc.wins += s.completed;
                    acc.fails += s.failed;
                    return acc;
                }, { wins: 0, fails: 0 });
            }, [habits, simulatedNow]);

            const consultarAlJuez = async () => {
                if (!storedApiKey) return;
                setIsAiLoading(true);
                const systemPrompt = `Eres el Juez del "Sistema 3 de Junio". Un usuario ha fallado y est√° en el "Espejo de Realidad". Sus estad√≠sticas globales son: ${globalStats.wins} victorias contra ${globalStats.fails} fallas. Lleva ${failurePorc/20} d√≠as sin registrar nada. Debes ser brutalmente honesto, fr√≠o y exigente. Eval√∫a su defensa. Si es aceptable, devuelve un JSON con valid:true y el veredicto. Si es mediocre, valid:false.`;
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${storedApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: reflection }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { valid: { type: "boolean" }, verdict: { type: "string" } } } }
                        })
                    });
                    const data = await response.json();
                    const res = JSON.parse(data.candidates[0].content.parts[0].text);
                    setAiFeedback(res.verdict);
                    setVerdictValid(res.valid);
                } catch (e) { setAiFeedback("ERROR DE CONEXI√ìN CON EL SISTEMA CENTRAL."); } finally { setIsAiLoading(false); }
            };

            const aceptarCompromiso = () => {
                setShowJuez(false);
                setLastWinDate(simulatedNow.toISOString());
                setAiFeedback("");
                setReflection("");
                setVerdictValid(false);
            };

            const handleMark = (id) => {
                setHabits(prev => prev.map(h => {
                    if (h.id === id && !h.history.includes(simulatedHoyStr)) {
                        setLastWinDate(simulatedNow.toISOString());
                        return { ...h, history: [...h.history, simulatedHoyStr] };
                    }
                    return h;
                }));
            };

            return (
                <div className="min-h-screen">
                    {/* ADMIN BAR */}
                    <div className="admin-panel p-3 px-6 flex items-center justify-between text-white border-b border-white/5">
                        <div className="flex flex-col">
                            <span className="text-[9px] font-black text-orange-500 uppercase tracking-widest leading-none mb-1">Testing Mode</span>
                            <span className="text-[10px] font-mono text-neutral-500 uppercase">{simulatedHoyStr}</span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setTimeOffset(prev => prev + 1)} className="bg-neutral-800 p-2 rounded-lg"><Icon name="Plus" className="w-3 h-3"/></button>
                            <button onClick={() => setTimeOffset(0)} className="bg-neutral-800 px-3 py-1 rounded-lg text-[9px] font-black">RESET</button>
                        </div>
                    </div>

                    <div className="max-w-2xl mx-auto px-6 pt-10 pb-40">
                        {/* HEADER PRINCIPAL */}
                        <header className="flex justify-between items-center mb-10">
                            <h1 className="text-5xl font-black italic text-white uppercase tracking-tighter leading-none">Seguimiento</h1>
                            <button onClick={() => setShowSettings(true)} className="w-12 h-12 bg-neutral-900 border border-neutral-800 rounded-full flex items-center justify-center">
                                <Icon name="Settings" color="#444" />
                            </button>
                        </header>

                        {/* STATUS BAR */}
                        <div className={`p-10 rounded-[3.5rem] border-2 mb-10 transition-all ${failurePorc > 70 ? 'failure-alert bg-red-950/20' : 'bg-neutral-900/50 border-neutral-800'}`}>
                            <div className="flex justify-between items-baseline mb-4">
                                <span className="text-[10px] font-black text-neutral-500 uppercase tracking-widest">Estado del Sujeto</span>
                                <span className={`text-6xl font-black italic tracking-tighter ${failurePorc > 70 ? 'text-red-500' : 'text-neutral-700'}`}>{failurePorc}%</span>
                            </div>
                            <div className="h-4 bg-black rounded-full overflow-hidden border border-white/5 p-1">
                                <div className={`h-full rounded-full transition-all duration-700 ${failurePorc > 70 ? 'bg-red-600' : 'bg-neutral-800'}`} style={{ width: `${failurePorc}%` }} />
                            </div>
                        </div>

                        {/* LISTA DE HABITOS */}
                        <div className="grid gap-6">
                            {habits.map(h => {
                                const stats = calculateStats(h);
                                const isDone = h.history.includes(simulatedHoyStr);
                                return (
                                    <div key={h.id} onClick={() => !isDone && handleMark(h.id)} className={`p-8 rounded-[2.8rem] bg-neutral-900/40 border-2 transition-all relative overflow-hidden ${isDone ? 'opacity-30 border-transparent' : 'border-neutral-800 active:scale-95 cursor-pointer shadow-xl'}`} style={{ borderLeft: `14px solid ${h.color}` }}>
                                        <div className="flex justify-between items-center mb-6">
                                            <div className="flex items-center gap-5">
                                                <span className="text-4xl">{h.icon}</span>
                                                <h3 className="text-2xl font-black italic text-white uppercase tracking-tighter leading-none">{h.name}</h3>
                                            </div>
                                            {isDone ? <Icon name="CheckCircle2" color="#34c759" className="w-10 h-10" /> : <Icon name="Circle" color="#111" className="w-10 h-10" />}
                                        </div>
                                        <div className="flex justify-between text-[10px] font-black uppercase italic text-neutral-600 tracking-tighter">
                                            <span>Avances: {stats.completed}</span>
                                            <span>Fallas: {stats.failed}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* MODAL JUEZ - ESPEJO DE REALIDAD */}
                    {showJuez && (
                        <div className="fixed inset-0 bg-black/98 z-[9999] flex items-center justify-center p-6 animate-in backdrop-blur-3xl overflow-y-auto">
                            <div className="glass-modal w-full max-w-2xl rounded-[5rem] p-12 md:p-20 text-center border-red-600/30 shadow-[0_0_100px_rgba(220,38,38,0.2)]">
                                <Icon name="ShieldAlert" className="w-24 h-24 mx-auto mb-10 text-red-600 animate-pulse" />
                                <h1 className="text-6xl font-black italic text-white uppercase mb-4 tracking-tighter leading-none">Espejo de Realidad</h1>
                                
                                {/* RESUMEN DE AVANCES Y FALLAS */}
                                <div className="grid grid-cols-2 gap-4 mb-12">
                                    <div className="bg-neutral-900/50 p-6 rounded-[2.5rem] border border-white/5">
                                        <p className="text-[10px] font-black text-neutral-500 uppercase mb-1">Victorias Totales</p>
                                        <p className="text-4xl font-black italic text-green-500">{globalStats.wins}</p>
                                    </div>
                                    <div className="bg-neutral-900/50 p-6 rounded-[2.5rem] border border-white/5">
                                        <p className="text-[10px] font-black text-neutral-500 uppercase mb-1">Fallas Acumuladas</p>
                                        <p className="text-4xl font-black italic text-red-600">{globalStats.fails}</p>
                                    </div>
                                </div>

                                <p className="text-[11px] font-black text-neutral-600 uppercase tracking-[0.6em] mb-12">D√çAS EN LA OSCURIDAD: {Math.floor(failurePorc/20)}</p>

                                {aiFeedback ? (
                                    <div className="space-y-10 animate-in">
                                        <div className="p-10 bg-red-950/20 border border-red-900/40 rounded-[3.5rem] text-lg italic text-red-100 uppercase tracking-tighter leading-snug">
                                            "{aiFeedback}"
                                        </div>
                                        {verdictValid ? (
                                            <button onClick={aceptarCompromiso} className="w-full btn-commitment py-9 rounded-[3.5rem] uppercase text-sm tracking-[0.5em]">
                                                ACEPTAR COMPROMISO
                                            </button>
                                        ) : (
                                            <button onClick={() => { setAiFeedback(""); setReflection(""); }} className="w-full bg-red-600 text-white font-black py-9 rounded-[3.5rem] uppercase text-sm tracking-[0.5em]">
                                                REINTENTAR DEFENSA
                                            </button>
                                        )}
                                    </div>
                                ) : (
                                    <div className="space-y-8">
                                        <textarea 
                                            value={reflection} 
                                            onChange={e => setReflection(e.target.value)} 
                                            placeholder="JUSTIFICA TU MEDIOCRIDAD ANTE EL SISTEMA..." 
                                            className="w-full bg-black border border-neutral-800 p-10 rounded-[3.5rem] text-white text-xs uppercase tracking-widest min-h-[220px] outline-none focus:border-red-600 transition-all text-center" 
                                        />
                                        <button 
                                            onClick={consultarAlJuez} 
                                            disabled={isAiLoading || !storedApiKey} 
                                            className="w-full py-9 bg-white text-black font-black rounded-[4rem] uppercase text-sm tracking-[0.4em] active:scale-95 shadow-2xl transition-all disabled:opacity-30"
                                        >
                                            {isAiLoading ? 'PROCESANDO...' : 'ENVIAR DEFENSA'}
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* NAV SIMPLE */}
                    <nav className="fixed bottom-12 left-1/2 -translate-x-1/2 bg-neutral-900/95 border border-neutral-800 rounded-full p-2.5 flex gap-4 shadow-2xl z-[100] w-[340px]">
                        <button onClick={() => setActiveTab('seguimiento')} className={`flex-1 py-5 rounded-full font-black uppercase text-[11px] tracking-[0.3em] ${activeTab === 'seguimiento' ? 'bg-white text-black' : 'text-neutral-600'}`}>Metas</button>
                        <button onClick={() => setShowSettings(true)} className="flex-1 py-5 rounded-full font-black uppercase text-[11px] tracking-[0.3em] text-neutral-600">Ajustes</button>
                    </nav>

                    {/* MODAL SETTINGS (Para API KEY) */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/90 z-[8000] flex items-center justify-center p-6 animate-in">
                            <div className="bg-neutral-950 w-full max-w-md rounded-[3rem] p-12 border border-white/5">
                                <h2 className="text-2xl font-black italic text-white uppercase mb-8">Sistema Central</h2>
                                <label className="text-[10px] font-black text-neutral-700 uppercase tracking-widest block mb-4">LLAVE DE INTELIGENCIA (GEMINI)</label>
                                <input 
                                    type="password" 
                                    value={storedApiKey} 
                                    onChange={e => {setStoredApiKey(e.target.value); localStorage.setItem(KEY_API, e.target.value);}} 
                                    className="w-full bg-black border border-neutral-800 p-5 rounded-2xl text-white text-xs mb-8" 
                                />
                                <button onClick={() => setShowSettings(false)} className="w-full py-5 bg-neutral-900 text-white font-black rounded-2xl uppercase text-[10px] tracking-widest">GUARDAR</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
