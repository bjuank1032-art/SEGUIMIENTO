<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sistema 3 de Junio - Admin Mode</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: black; color: #e5e5e5; font-family: 'Inter', sans-serif; padding-bottom: 120px; }
        .glass-modal { background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-dark { background: #0a0a0a; border: 1px solid #1a1a1a; color: white; }
        .admin-bar { background: #1c1c1e; border-bottom: 1px solid #333; z-index: 9999; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .failure-alert { animation: shake 0.2s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const KEY_H = 'res_v13_habits';
        const KEY_W = 'last_win_date';
        const KEY_API = 'gemini_stored_key';
        const DAYS_WEEK = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];

        // --- COMPONENTE ICONO ---
        const Icon = ({ name, className = "w-5 h-5", color = "currentColor" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    iconRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    const lucideName = name.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
                    i.setAttribute('data-lucide', lucideName);
                    i.className = className;
                    i.style.stroke = color;
                    i.style.strokeWidth = "2.5";
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons();
                }
            }, [name, className, color]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        const App = () => {
            // --- ESTADO DE TIEMPO (ADMIN) ---
            const [timeOffset, setTimeOffset] = useState(0); 
            const simulatedNow = useMemo(() => new Date(Date.now() + timeOffset * 86400000), [timeOffset]);
            const simulatedHoyStr = simulatedNow.toISOString().split('T')[0];

            const [activeTab, setActiveTab] = useState('seguimiento');
            const [habits, setHabits] = useState(() => JSON.parse(localStorage.getItem(KEY_H)) || []);
            const [lastWinDate, setLastWinDate] = useState(() => localStorage.getItem(KEY_W) || null);
            const [showJuez, setShowJuez] = useState(false);
            const [reflection, setReflection] = useState("");
            const [aiFeedback, setAiFeedback] = useState("");
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [verdictValid, setVerdictValid] = useState(null);
            const [storedApiKey, setStoredApiKey] = useState(localStorage.getItem(KEY_API) || "");

            // Persistencia
            useEffect(() => {
                localStorage.setItem(KEY_H, JSON.stringify(habits));
                if (lastWinDate) localStorage.setItem(KEY_W, lastWinDate);
            }, [habits, lastWinDate]);

            // --- L√ìGICA DE IA (JUEZ) ---
            const failurePorc = useMemo(() => {
                if (!lastWinDate) return 0;
                const last = new Date(lastWinDate);
                last.setHours(0,0,0,0);
                const today = new Date(simulatedNow);
                today.setHours(0,0,0,0);
                const diffDays = Math.floor((today - last) / (1000 * 60 * 60 * 24));
                return Math.min(100, diffDays * 20); // 20% por d√≠a de inactividad
            }, [lastWinDate, simulatedNow]);

            useEffect(() => {
                if (failurePorc >= 100) setShowJuez(true);
            }, [failurePorc]);

            const consultarAlJuez = async () => {
                if (!storedApiKey) return;
                setIsAiLoading(true);
                const prompt = `Usuario fall√≥ su sistema por ${Math.floor(failurePorc/20)} d√≠as. Su defensa es: "${reflection}". Responde como un juez estricto del "Sistema 3 de Junio". S√© √°cido, menciona que tiene 57kg y que la purga es supervivencia. Si la defensa es buena, di que es v√°lida.`;
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${storedApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { 
                                responseMimeType: "application/json", 
                                responseSchema: { 
                                    type: "OBJECT", 
                                    properties: { 
                                        valid: { type: "boolean" }, 
                                        verdict: { type: "string" } 
                                    } 
                                } 
                            }
                        })
                    });
                    const data = await response.json();
                    const result = JSON.parse(data.candidates[0].content.parts[0].text);
                    setAiFeedback(result.verdict);
                    setVerdictValid(result.valid);
                } catch (e) {
                    setAiFeedback("Error de conexi√≥n con el Sistema Central. Reintenta.");
                } finally { setIsAiLoading(false); }
            };

            const handleMark = (id) => {
                setHabits(prev => prev.map(h => {
                    if (h.id === id && !h.history.includes(simulatedHoyStr)) {
                        setLastWinDate(simulatedNow.toISOString());
                        return { ...h, history: [...h.history, simulatedHoyStr] };
                    }
                    return h;
                }));
            };

            const calculateHabitStats = (h) => {
                const start = new Date(h.startDate);
                start.setHours(0,0,0,0);
                const today = new Date(simulatedNow);
                today.setHours(0,0,0,0);
                
                const diffDays = Math.floor((today - start) / (1000 * 60 * 60 * 24)) + 1;
                const completed = h.history.length;
                const failed = Math.max(0, diffDays - completed);
                const progress = Math.min(100, Math.round((completed / (h.duration || 30)) * 100));
                
                return { completed, failed, progress };
            };

            return (
                <div className="min-h-screen">
                    {/* --- PANEL DE ADMINISTRADOR --- */}
                    <div className="admin-bar p-3 flex items-center justify-between sticky top-0">
                        <div className="flex items-center gap-4">
                            <span className="text-[10px] font-black text-orange-500 uppercase">Admin Mode</span>
                            <span className="text-[10px] text-neutral-400 font-mono">
                                Reloj: {simulatedHoyStr} ({timeOffset >= 0 ? `+${timeOffset}` : timeOffset}d)
                            </span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setTimeOffset(prev => prev + 1)} className="bg-neutral-800 px-3 py-1 rounded text-[10px] font-bold">+1 D√≠a</button>
                            <button onClick={() => setTimeOffset(0)} className="bg-neutral-800 px-3 py-1 rounded text-[10px] font-bold">Reset</button>
                            <button onClick={() => setShowJuez(true)} className="bg-red-900/50 text-red-400 px-3 py-1 rounded text-[10px] font-bold">Forzar Juez</button>
                        </div>
                    </div>

                    <div className="max-w-2xl mx-auto px-6 pt-10">
                        <header className="mb-10">
                            <h1 className="text-5xl font-black italic text-white uppercase tracking-tighter">Seguimiento</h1>
                            <p className="text-[10px] text-neutral-500 font-bold uppercase tracking-widest mt-2">Prueba de Funcionalidad IA & Tiempo</p>
                        </header>

                        {/* BARRA DE FRACASADO */}
                        <div className={`mb-12 p-10 rounded-[3rem] border-2 transition-all ${failurePorc > 70 ? 'failure-alert border-red-600 bg-red-950/20' : 'bg-neutral-900 border-neutral-800'}`}>
                            <div className="flex justify-between items-baseline mb-4">
                                <span className="text-[10px] font-black uppercase text-neutral-500">Nivel de Fracaso</span>
                                <span className={`text-6xl font-black italic ${failurePorc > 70 ? 'text-red-500' : 'text-neutral-700'}`}>{failurePorc}%</span>
                            </div>
                            <div className="h-3 bg-black rounded-full overflow-hidden">
                                <div className={`h-full transition-all duration-500 ${failurePorc > 70 ? 'bg-red-600' : 'bg-neutral-800'}`} style={{ width: `${failurePorc}%` }} />
                            </div>
                            <p className="text-[9px] text-neutral-600 mt-4 italic uppercase tracking-tighter">Si esta barra llega a 100%, el Juez bloquear√° el sistema.</p>
                        </div>

                        {/* LISTA DE METAS */}
                        <div className="grid gap-6">
                            {habits.length === 0 && (
                                <div className="text-center py-20 border-2 border-dashed border-neutral-800 rounded-[3rem] text-neutral-600">
                                    No hay misiones. Ve a ajustes para crear una.
                                </div>
                            )}
                            {habits.map(h => {
                                const stats = calculateHabitStats(h);
                                const isDone = h.history.includes(simulatedHoyStr);
                                return (
                                    <div key={h.id} onClick={() => !isDone && handleMark(h.id)} className={`p-8 rounded-[2.5rem] bg-neutral-900/50 border-2 transition-all cursor-pointer ${isDone ? 'opacity-40 border-transparent' : 'border-neutral-800 active:scale-95'}`}>
                                        <div className="flex justify-between items-center mb-6">
                                            <div className="flex items-center gap-4">
                                                <span className="text-4xl">{h.icon}</span>
                                                <h3 className="text-xl font-black italic text-white uppercase">{h.name}</h3>
                                            </div>
                                            {isDone ? <Icon name="CheckCircle2" className="w-8 h-8 text-green-500" /> : <Icon name="Circle" className="w-8 h-8 text-neutral-700" />}
                                        </div>
                                        <div className="h-2 bg-black rounded-full overflow-hidden mb-4">
                                            <div className="h-full" style={{ width: `${stats.progress}%`, backgroundColor: h.color }} />
                                        </div>
                                        <div className="flex justify-between text-[10px] font-black text-neutral-500 uppercase italic">
                                            <span className="text-green-600">Cumplidos: {stats.completed}</span>
                                            <span className="text-red-600">Fallados: {stats.failed}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* MODAL DEL JUEZ (IA) */}
                    {showJuez && (
                        <div className="fixed inset-0 bg-black/95 z-[9999] flex items-center justify-center p-6 animate-in">
                            <div className="glass-modal w-full max-w-lg rounded-[4rem] p-12 text-center border-red-500/30">
                                <Icon name="ShieldAlert" className="w-20 h-20 mx-auto mb-8 text-red-600" />
                                <h2 className="text-4xl font-black italic text-white uppercase mb-4 tracking-tighter">Espejo de Realidad</h2>
                                <p className="text-xs text-neutral-500 font-bold mb-8 uppercase tracking-widest leading-relaxed">
                                    Has abandonado el sistema por {Math.floor(failurePorc/20)} d√≠as. <br/>Presenta tu defensa ante el Juez.
                                </p>

                                {aiFeedback ? (
                                    <div className="space-y-6 animate-in">
                                        <div className="p-6 bg-red-900/10 border border-red-500/20 rounded-3xl text-sm italic text-red-200 leading-relaxed uppercase">
                                            "{aiFeedback}"
                                        </div>
                                        {verdictValid ? (
                                            <button onClick={() => { setShowJuez(false); setLastWinDate(simulatedNow.toISOString()); setAiFeedback(""); }} className="w-full bg-white text-black font-black py-6 rounded-3xl uppercase text-xs tracking-widest shadow-2xl">Retomar el Camino</button>
                                        ) : (
                                            <button onClick={() => { setAiFeedback(""); setReflection(""); }} className="w-full bg-red-600 text-white font-black py-6 rounded-3xl uppercase text-xs tracking-widest">Reintentar Defensa</button>
                                        )}
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        <textarea 
                                            value={reflection} 
                                            onChange={e => setReflection(e.target.value)} 
                                            placeholder="Escribe tu justificaci√≥n aqu√≠..." 
                                            className="w-full bg-black border border-neutral-800 rounded-3xl p-6 text-white text-sm outline-none min-h-[150px] resize-none"
                                        />
                                        <button 
                                            onClick={consultarAlJuez} 
                                            disabled={isAiLoading || !storedApiKey}
                                            className="w-full bg-white text-black font-black py-6 rounded-3xl uppercase text-xs tracking-widest active:scale-95 disabled:opacity-50"
                                        >
                                            {isAiLoading ? "Evaluando..." : "Enviar Defensa"}
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* BARRA DE NAVEGACI√ìN SIMPLE */}
                    <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-neutral-900/90 border border-neutral-800 p-2 rounded-full flex gap-2 w-72">
                        <button onClick={() => setActiveTab('seguimiento')} className="flex-1 py-4 bg-white text-black rounded-full font-black text-[10px] uppercase">Metas</button>
                        <button onClick={() => setShowSettings(true)} className="flex-1 py-4 text-neutral-500 rounded-full font-black text-[10px] uppercase">Ajustes</button>
                    </nav>

                    {/* MODAL CONFIGURACI√ìN (Para a√±adir API Key) */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 z-[8000] flex items-center justify-center p-6 animate-in">
                            <div className="glass-modal w-full max-w-md rounded-[3rem] p-10">
                                <div className="flex justify-between items-center mb-10">
                                    <h2 className="text-2xl font-black italic text-white uppercase">Ajustes Admin</h2>
                                    <button onClick={() => setShowSettings(false)} className="w-10 h-10 bg-neutral-900 rounded-full flex items-center justify-center"><Icon name="X" /></button>
                                </div>
                                <div className="space-y-6">
                                    <div>
                                        <label className="text-[10px] font-black text-neutral-600 uppercase mb-2 block tracking-widest">API Key Gemini (Requerida para IA)</label>
                                        <input 
                                            type="password" 
                                            value={storedApiKey} 
                                            onChange={e => {setStoredApiKey(e.target.value); localStorage.setItem(KEY_API, e.target.value);}} 
                                            className="w-full bg-black border border-neutral-800 p-4 rounded-2xl text-white text-xs" 
                                        />
                                    </div>
                                    <div className="pt-4 border-t border-white/5">
                                        <button 
                                            onClick={() => {
                                                const h = { id: 'test', name: "Meta Test", icon: "üî•", color: "#007aff", duration: 30, startDate: simulatedNow.toISOString(), history: [], type: 'simple' };
                                                setHabits([...habits, h]);
                                                setShowSettings(false);
                                            }} 
                                            className="w-full py-4 bg-neutral-800 text-white font-black rounded-2xl text-[10px] uppercase"
                                        >
                                            Crear Meta de Prueba
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
